<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>10. NAT, IPv6, RIP, OSPF, BGP</title></head>
<body><h1>10. NAT, IPv6, RIP, OSPF, BGP</h1>
<h2>NAT</h2>
<p>Motivations:</p>
<ul>
<li>ISP only needs to allocate IP per customer</li>
<li>Can change addresses of devices in the local network without the outside world needing to know</li>
<li>Can change ISP without changing local addresses</li>
<li>Devices in local network not explicitly addressable by outside world</li>

</ul>
<p>Each device has an internal IP address, but packets exiting the network have their source address transformed into a single public IP address.</p>
<p>Question: how does the router know which host to forward returning traffic if all devices have the same public IP address?</p>
<p>A table mapping a (external IP, external port) tuple to an (internal IP, internal port) tuple. When the device sends a packet, the router will <strong>randomly choose</strong> an external port to use, and when the response packet arrives, it can simply map this to the device&#39;s internal IP and port.</p>
<p>The port number is a 16 bit field, so it theoretically allows over 60,000 simultaneous connections.</p>
<p>Controversy:</p>
<ul>
<li>Port numbers address processes, not hosts</li>
<li>Port numbers are layer 4; routers should only process up to layer 3</li>
<li>Violates end-to-end agreement; hosts no longer talk directly to each other</li>
<li>IPv6 is a better solution</li>

</ul>
<h2>IPv6</h2>
<p>Motivations:</p>
<ul>
<li><p>IPv4 address space getting full</p>
</li>
<li><p>Header format helps speed up processing/forwarding</p>
<ul>
<li>Faciliates QoS</li>

</ul>
</li>

</ul>
<h3>Datagram Format</h3>
<p>IPv6 is simpler; no fragmentation, no checksums, fixed length (40 bytes) header:</p>
<ul>
<li>Version (4), value 6</li>
<li>Traffic class (8): facilitates QoS</li>
<li>Flow label (20): packet identifier</li>
<li>Payload length (16): length of payload in bytes</li>
<li>Next header (8): type of next (upper-layer) header (e.g. TCP, UDP)  </li>
<li>Hop limit (8): TTL</li>
<li>Source address (128)</li>
<li>Destination address (128)</li>
<li>Payload</li>

</ul>
<h3>Transition</h3>
<p>Old devices only support IPv4, and some routers cannot be upgraded. Hence, &#39;flag days&#39;, where the world switches protocol on some specified day, will not work.</p>
<p>With a <strong>dual-stack approach</strong>, all IPv6 nodes also have complete IPv4 implementations, allowing packets to be transformed in both directions as it is routed. This loses IPv6 or IPv4 specific fields.</p>
<p>Another approach is <strong>tunneling</strong>: stuff the whole IPv6 datagram as the payload of a IPv4 datagram. If the packet is small enough and <code>DF</code> is set, a IPv6 router can then parse the payload and forward it as a IPv6 packet.</p>
<p>Due to DHCP, CIDRised addresses and NAT partially solving the IP address shortage problem (in the short term), IPv6 adoption has been slow.</p>
<h2>Routing in the Internet</h2>
<p>Flat networks don&#39;t scale: if you have millions of hosts, storing routing information for each requires large amounts of memory. If link-state routing is used, broadcasting LS updates takes too much bandwidth, and if distance-vector routing is used, it will never converge.</p>
<h3>Hierarchical Routing</h3>
<p>Hierarchical routing aggregates routers into <strong>autonomous regions</strong>, where routers belong to the same organization and run the same intra-AS routing protocol.</p>
<p>Gateway routers have a direct link to a router in another AS.</p>
<p>The forwarding table is configured by both intra- and inter-AS routing algorithms:</p>
<ul>
<li>The intra-AS algorithm sets entries for <strong>internal and external destinations</strong></li>
<li>The inter-AS algorithm sets entries for only external destinations</li>

</ul>
<h4>Routing between ASes</h4>
<p>Case 1: a single gateway router to only one other AS:</p>
<ul>
<li>Just forward all external traffic to that gateway router</li>

</ul>
<p>Case 2: two or more physical links to other ASes (typically a transit AS):</p>
<ul>
<li>Learn from the inter-AS protocol that subnet <em>X</em> is reachable via multiple gateways</li>
<li>Use routing information from intra-AS protocol to determine costs of path to each of the gateways</li>
<li>Hot potato routing; choose the closest gateway</li>
<li>Determine interface <em>I</em> that connects to first router on the path to the nearest gateway; insert <code>(X, I)</code> into the forwarding table</li>

</ul>
<h3>RIP - Routing Information Protocol</h3>
<p>Uses the distance vector algorithm.</p>
<p>Distance metric:</p>
<ul>
<li>Number of hops, max 15</li>
<li>Number of subnets traversed along the shortest path from the source router to the destination subnet, including the destination subset (hence it is always at least 1)</li>

</ul>
<p>To determine subnets, detach each interface from its host/router to create islands of isolated networks; the interfaces are the endpoints of the isolated networks, called subnets.</p>
<p>RIP advertisements:</p>
<ul>
<li><p>Distance vectors exchanged among neighbours every 30 seconds via Response Message</p>
<ul>
<li>They are also called advertisements, and are sent in <strong>UDP packets</strong> (layer-4)</li>
<li>An <strong>application-level</strong> process (daemon) called <code>route-d</code> manages the RIP routing tables - UDP is level 4 so it cannot be managed at the router level</li>

</ul>
</li>
<li><p>Each advertisement contains a list of up to 25 destination nets within the AS</p>
</li>

</ul>
<p>Example:</p>
<pre><code>w-- A --x-- D --y-- B-- ... --`z`
    |
    C
</code></pre>
<p>The routing table in <code>D</code> would have:</p>
<figure><table>
<thead>
<tr><th>Dest. net</th><th>Next router</th><th>Num. hops</th></tr></thead>
<tbody><tr><td><code>w</code></td><td><code>A</code></td><td>2</td></tr><tr><td><code>y</code></td><td><code>B</code></td><td>2</td></tr><tr><td><code>z</code></td><td><code>B</code></td><td>7</td></tr><tr><td><code>x</code></td><td>NA</td><td>1</td></tr></tbody>
</table></figure>
<p>If <code>A</code> then advertises its own routing table where the cost to <code>z</code> (through <code>C</code>) is 4, <code>D</code> would use the Bellman-Ford equation and update its routing table to route requests to <code>z</code> through <code>A</code> with a cost of 5.</p>
<h4>Link Failure and Recovery</h4>
<p>After 180 seconds of no advertisements, the neighbour/link is declared dead; routes going through that neighbour are invalidated and new advertisements are sent to neighbours. Through this, the link failure information propagates through the entire network.</p>
<h4>Differences between RIP and the DV Algorithm</h4>
<ul>
<li>Can advertise a maximum of 25 subsets</li>
<li>The link cost is always 1 in RIP</li>
<li>Nodes in the DV algorithm are subsets</li>
<li>Instead of distance vectors, it sends the routing table</li>
<li>Routers do not store their neighbours&#39; DVs</li>
<li>Routers exchange advertisements at fixed intervals, not when there are updates</li>
<li>Does not have the count-to-infinity problem - has the count-to-16 problem</li>

</ul>
<h3>OSPF - Open Shortest Path First</h3>
<ul>
<li><p>Uses the link state algorithm</p>
</li>
<li><p>Algorithms are disseminated to <strong>the entire AS</strong> via broadcast messages (flooding)</p>
<ul>
<li>OSPF messages sent <strong>directly over IP</strong> (layer 3), not TCP/UDP</li>

</ul>
</li>
<li><p>Typically deployed in upper-tier ISPs</p>
</li>

</ul>
<p>Advanced features not in RIP:</p>
<ul>
<li>Security: all OSPF messages are authenticated</li>
<li>Multiple same-cost paths allowed</li>
<li>Link cost can be set by admins (traffic engineering)</li>
<li>Unicast and multicast support (one-to-one and one-to-group)</li>
<li>Two-level hierarchy</li>

</ul>
<p>OSPF ASes are configured into areas. Within an area:</p>
<ul>
<li>Each area runs its own OSPF algorithm</li>
<li>Link-state advertisements do not exit the area</li>
<li>Each node has detailed area topology</li>
<li><strong>Area border routers</strong> send summarized distance information to nets in its own areas and advertise to other area border routers</li>

</ul>
<p>There is one backbone area which links areas together. In the backbone:</p>
<ul>
<li>Routers that run OSPF routing within the backbone area called <strong>backbone routers</strong></li>
<li><strong>Boundary routers</strong> connect to other AS&#39;s, typically through BGP</li>

</ul>
<h3>BGP - Border Gateway Protocol</h3>
<p>The de facto standard. Provides each AS with the ability to:</p>
<ul>
<li>Obtain subnet reachability information</li>
<li>Propagate the reachability information</li>
<li>Determines &#39;good&#39; routes to subsets</li>

</ul>
<p>Pairs of routers - BGP peers, exchange routing information over <strong>TCP connections</strong> (called <strong>BGP sessions</strong>).</p>
<p><strong>eBGP</strong> sessions allow routers in two different AS&#39;s to exchange reachability information - when it advertises a prefix, it promises that it can forward any datagrams destined to that prefix. The receiver can then create an entry for that prefix in its forwarding table and <strong>re-advertise the same information to others</strong> via <strong>iBGP</strong> (between routers in the same AS) or <strong>eBGP</strong> sessions.</p>
<p>The advertisement is a combination of the <strong>prefix</strong> and <strong>attributes</strong>. Two important attributes are:</p>
<ul>
<li><code>AS_PATH</code>: not updated in iBGP connections. Contains a list of ASes through which the advertisement has passed - reject if already in the path</li>
<li><code>NEXT_HOP</code>: not updated in iBGP connections. Advertisements flow from the destination outwards, so it contains the address of the boundary router for the next-hop AS</li>
<li>An <strong>import policy</strong> is used to accept or decline adverts</li>

</ul>
<h4>Route selection</h4>
<p>Routers may learn about more than one route to a given prefix, so it uses elimination rules to pick one:</p>
<ol start='' >
<li>Local preference value attribute (policy decision)</li>
<li>Shortest AS-PATH (DV algorithm)</li>
<li>Closest NEXT-HOP router (hot potato routing)</li>
<li>Additional criteria</li>

</ol>
<p>Routing policy can affect routing. For example, a <em>keep silent policy</em> could occur if <em>X</em> is a dual-homed (e.g. for redundancy) customer network connected to <em>B</em> and <em>C</em> provider networks; it will not want to route traffic from <em>B</em> to <em>C</em> and hence hence, it will not advertise to <em>B</em> a route to <em>C</em>, or vice versa.</p>
</body>
</html>